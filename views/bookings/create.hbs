<div class="row justify-content-center">
    <div class="col-lg-7 col-md-9">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-white text-center py-4 border-bottom">
                <h4 class="mb-1 fw-bold text-primary">Tạo Đơn Hàng Mới</h4>
                <p class="text-secondary small mb-0">Thiết lập thông tin thuê xe</p>
            </div>
            <div class="card-body p-4 p-md-5">
                <form action="/bookings/store" method="POST" id="bookingForm">

                    <div class="mb-4">
                        <label class="form-label text-uppercase small fw-bold text-secondary ls-1">Khách hàng thuê
                            xe</label>
                        <select name="userId" class="form-select form-select-lg bg-light border-0 focus-ring-none"
                            required>
                            <option value="">-- Chọn khách hàng --</option>
                            {{#each users}}
                            <option value="{{this._id}}">{{this.name}} ({{this.email}})</option>
                            {{/each}}
                        </select>
                        <div class="form-text mt-2"><i class="bi bi-info-circle me-1"></i>Chỉ hiển thị Khách hàng.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-uppercase small fw-bold text-secondary ls-1">Chọn xe</label>
                        <select name="carId" id="carSelect"
                            class="form-select form-select-lg bg-light border-0 focus-ring-none" required
                            onchange="calculateTotal()">
                            <option value="" data-price="0">-- Chọn xe để thuê --</option>
                            {{#each cars}}
                            <option value="{{this._id}}" data-price="{{this.pricePerDay}}">
                                {{this.brand}} {{this.model}}
                                (Price: ${{this.pricePerDay}}/day)
                            </option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-uppercase small fw-bold text-secondary ls-1">Ngày bắt
                                đầu</label>
                            <input type="date" name="startDate" id="startDate"
                                class="form-control form-control-lg bg-light border-0 focus-ring-none" required
                                onchange="calculateTotal()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-uppercase small fw-bold text-secondary ls-1">Ngày kết
                                thúc</label>
                            <input type="date" name="endDate" id="endDate"
                                class="form-control form-control-lg bg-light border-0 focus-ring-none" required
                                onchange="calculateTotal()">

                            <div id="dateError" class="text-danger mt-2 small fw-bold" style="display: none;">
                                <i class="bi bi-exclamation-circle-fill me-1"></i> Ngày kết thúc phải sau ngày bắt đầu!
                            </div>
                        </div>
                    </div>

                    <div
                        class="alert alert-primary bg-primary-subtle border-0 rounded-3 d-flex justify-content-between align-items-center mb-4 p-3">
                        <span class="fw-bold text-primary-emphasis small text-uppercase ls-1">Tổng thanh toán dự
                            kiến:</span>
                        <h3 class="mb-0 fw-bold text-primary" id="totalDisplay">$0</h3>
                    </div>

                    <hr class="my-4 border-secondary-subtle">

                    <div class="d-flex justify-content-between align-items-center">
                        <a href="/bookings" class="text-decoration-none text-secondary fw-medium"><i
                                class="bi bi-arrow-left me-1"></i> Hủy bỏ</a>
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm px-5 rounded-pill fw-bold"
                            id="btnSubmit">Xác nhận Đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function calculateTotal() {
        // 1. Lấy các phần tử từ HTML
        const carSelect = document.getElementById('carSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const totalDisplay = document.getElementById('totalDisplay');
        const dateError = document.getElementById('dateError');
        const btnSubmit = document.getElementById('btnSubmit');

        // 2. Lấy giá trị hiện tại
        // Lấy giá tiền từ attribute data-price của option đang chọn
        const pricePerDay = parseInt(carSelect.options[carSelect.selectedIndex].getAttribute('data-price')) || 0;
        const start = new Date(startDateInput.value);
        const end = new Date(endDateInput.value);

        // Reset trạng thái lỗi mặc định
        dateError.style.display = 'none';
        endDateInput.classList.remove('is-invalid'); // Bỏ viền đỏ
        btnSubmit.disabled = false; // Mở lại nút submit

        // Nếu chưa nhập đủ thông tin thì hiển thị $0
        if (!startDateInput.value || !endDateInput.value || pricePerDay === 0) {
            totalDisplay.innerText = "$0";
            return;
        }

        // 3. VALIDATE: Kiểm tra ngày kết thúc <= Ngày bắt đầu
        if (end <= start) {
            dateError.style.display = 'block'; // Hiện thông báo lỗi
            endDateInput.classList.add('is-invalid'); // Thêm viền đỏ cho ô nhập
            totalDisplay.innerText = "$0"; // Reset tiền về 0
            btnSubmit.disabled = true; // Khóa nút submit không cho gửi
            return;
        }

        // 4. TÍNH TOÁN TIỀN
        // Tính khoảng cách thời gian (miliseconds)
        const diffTime = Math.abs(end - start);
        // Quy đổi ra ngày (làm tròn lên)
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const total = diffDays * pricePerDay;

        // 5. HIỂN THỊ KẾT QUẢ
        totalDisplay.innerText = "$" + total.toLocaleString('en-US');
    }
</script>