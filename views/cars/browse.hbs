{{!-- views/cars/browse.hbs - BROWSE XE s·ª≠ d·ª•ng Bootstrap 5 layout --}}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark mb-0">T√¨m ki·∫øm Xe</h2>
        <p class="text-secondary small mb-0">T√¨m xe ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa b·∫°n</p>
    </div>
</div>

{{!-- QUICK SEARCH FORM --}}
<div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
    <div class="card-header bg-primary text-white py-3">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-search me-2"></i>T√¨m ki·∫øm nhanh
        </h5>
    </div>
    <div class="card-body">
        <form action="/search" method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label small text-muted fw-bold">
                    <i class="bi bi-geo-alt me-1"></i>Th√†nh ph·ªë
                </label>
                <input type="text" class="form-control" name="city" placeholder="Nh·∫≠p th√†nh ph·ªë..."
                    value="{{filters.city}}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted fw-bold">
                    <i class="bi bi-calendar-check me-1"></i>Ng√†y nh·∫≠n xe
                </label>
                <input type="date" class="form-control" name="startDate" value="{{filters.startDate}}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted fw-bold">
                    <i class="bi bi-calendar-x me-1"></i>Ng√†y tr·∫£ xe
                </label>
                <input type="date" class="form-control" name="endDate" value="{{filters.endDate}}">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-warning w-100 fw-bold shadow-sm">
                    <i class="bi bi-search me-1"></i>T√¨m ki·∫øm
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    {{!-- SIDEBAR FILTERS --}}
    <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden sticky-top" style="top: 20px;">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-muted small fw-bold text-uppercase ls-1">
                    <i class="bi bi-funnel me-2"></i>B·ªô l·ªçc
                </h5>
                <a href="/search" class="text-primary small text-decoration-none">ƒê·∫∑t l·∫°i</a>
            </div>
            <div class="card-body">
                <form action="/search" method="GET">
                    {{!-- CATEGORY --}}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark small">Lo·∫°i xe</label>
                        <select name="category" class="form-select form-select-sm">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="ECONOMY" {{#if (eq filters.category 'ECONOMY' )}}selected{{/if}}>üöô Ti·∫øt ki·ªám
                            </option>
                            <option value="COMFORT" {{#if (eq filters.category 'COMFORT' )}}selected{{/if}}>üöó Tho·∫£i m√°i
                            </option>
                            <option value="PREMIUM" {{#if (eq filters.category 'PREMIUM' )}}selected{{/if}}>‚ú® Cao c·∫•p
                            </option>
                            <option value="SUV" {{#if (eq filters.category 'SUV' )}}selected{{/if}}>üöô SUV</option>
                            <option value="VAN" {{#if (eq filters.category 'VAN' )}}selected{{/if}}>üöê Van</option>
                            <option value="LUXURY" {{#if (eq filters.category 'LUXURY' )}}selected{{/if}}>üíé Sang tr·ªçng
                            </option>
                        </select>
                    </div>

                    {{!-- TRANSMISSION --}}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark small">H·ªôp s·ªë</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="transmission" value="AUTOMATIC"
                                id="transAuto" {{#if (includes filters.transmission 'AUTOMATIC' )}}checked{{/if}}>
                            <label class="form-check-label small" for="transAuto">T·ª± ƒë·ªông</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="transmission" value="MANUAL"
                                id="transManual" {{#if (includes filters.transmission 'MANUAL' )}}checked{{/if}}>
                            <label class="form-check-label small" for="transManual">S·ªë s√†n</label>
                        </div>
                    </div>

                    {{!-- FUEL TYPE --}}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark small">Nhi√™n li·ªáu</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fuelType" value="PETROL"
                                id="fuelPetrol" {{#if (includes filters.fuelType 'PETROL' )}}checked{{/if}}>
                            <label class="form-check-label small" for="fuelPetrol">‚õΩ XƒÉng</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fuelType" value="DIESEL"
                                id="fuelDiesel" {{#if (includes filters.fuelType 'DIESEL' )}}checked{{/if}}>
                            <label class="form-check-label small" for="fuelDiesel">üõ¢Ô∏è D·∫ßu</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fuelType" value="ELECTRIC"
                                id="fuelElectric" {{#if (includes filters.fuelType 'ELECTRIC' )}}checked{{/if}}>
                            <label class="form-check-label small" for="fuelElectric">‚ö° ƒêi·ªán</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fuelType" value="HYBRID"
                                id="fuelHybrid" {{#if (includes filters.fuelType 'HYBRID' )}}checked{{/if}}>
                            <label class="form-check-label small" for="fuelHybrid">üîã Hybrid</label>
                        </div>
                    </div>

                    {{!-- PRICE RANGE --}}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark small">Gi√° thu√™/ng√†y</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" name="minPrice"
                                    placeholder="T·ª´" value="{{filters.minPrice}}">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" name="maxPrice"
                                    placeholder="ƒê·∫øn" value="{{filters.maxPrice}}">
                            </div>
                        </div>
                    </div>

                    {{!-- SEATS --}}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-dark small">S·ªë ch·ªó ng·ªìi</label>
                        <select name="minSeats" class="form-select form-select-sm">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="2" {{#if (eq filters.minSeats '2' )}}selected{{/if}}>2+ ch·ªó</option>
                            <option value="4" {{#if (eq filters.minSeats '4' )}}selected{{/if}}>4+ ch·ªó</option>
                            <option value="5" {{#if (eq filters.minSeats '5' )}}selected{{/if}}>5+ ch·ªó</option>
                            <option value="7" {{#if (eq filters.minSeats '7' )}}selected{{/if}}>7+ ch·ªó</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 shadow-sm">
                        <i class="bi bi-filter me-1"></i>√Åp d·ª•ng b·ªô l·ªçc
                    </button>
                </form>
            </div>
        </div>
    </div>

    {{!-- RESULTS AREA --}}
    <div class="col-md-9">
        {{!-- TOOLBAR --}}
        <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-muted small fw-bold text-uppercase ls-1">
                    <i class="bi bi-car-front me-2"></i>{{pagination.totalCars}} xe kh·∫£ d·ª•ng
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <select name="sortBy" class="form-select form-select-sm" onchange="applySort(this.value)"
                        style="width: auto;">
                        <option value="pricePerDay" {{#if (eq filters.sortBy 'pricePerDay' )}}selected{{/if}}>Gi√° th·∫•p
                            nh·∫•t</option>
                        <option value="-pricePerDay" {{#if (eq filters.sortBy '-pricePerDay' )}}selected{{/if}}>Gi√° cao
                            nh·∫•t</option>
                        <option value="-averageRating" {{#if (eq filters.sortBy '-averageRating' )}}selected{{/if}}>ƒê√°nh
                            gi√° cao</option>
                        <option value="-totalReviews" {{#if (eq filters.sortBy '-totalReviews' )}}selected{{/if}}>Ph·ªï
                            bi·∫øn nh·∫•t</option>
                    </select>
                </div>
            </div>
        </div>

        {{!-- CAR GRID --}}
        <div class="row g-4">
            {{#if cars.length}}
            {{#each cars}}
            <div class="col-md-6 col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden card-hover">
                    {{!-- CAR IMAGE --}}
                    <div class="position-relative" style="height: 180px; background: #f1f5f9;">
                        {{#if images.[0]}}
                        <img src="{{images.[0]}}" alt="{{brand}} {{model}}" class="w-100 h-100"
                            style="object-fit: cover;">
                        {{else}}
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-image fs-1"></i>
                        </div>
                        {{/if}}
                        {{#if (gte averageRating 4.5)}}
                        <span class="position-absolute top-0 end-0 m-2 badge bg-warning text-dark">
                            ‚≠ê Top rated
                        </span>
                        {{/if}}
                        <span class="position-absolute bottom-0 start-0 m-2 badge bg-dark bg-opacity-75">
                            {{category}}
                        </span>
                    </div>

                    {{!-- CAR INFO --}}
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold text-dark mb-0">{{brand}} {{model}}</h6>
                            <span class="badge bg-light text-secondary border">{{year}}</span>
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-2 small text-secondary">
                            <span><i class="bi bi-people me-1"></i>{{seats}} ch·ªó</span>
                            <span><i class="bi bi-gear me-1"></i>{{transmission}}</span>
                            <span><i class="bi bi-fuel-pump me-1"></i>{{fuelType}}</span>
                        </div>

                        {{#if location.city}}
                        <p class="small text-muted mb-2">
                            <i class="bi bi-geo-alt me-1"></i>{{location.city}}{{#if location.district}},
                            {{location.district}}{{/if}}
                        </p>
                        {{/if}}

                        {{#if averageRating}}
                        <div class="mb-2">
                            <span class="text-warning fw-bold">‚≠ê {{averageRating}}</span>
                            <span class="text-muted small">({{totalReviews}} ƒë√°nh gi√°)</span>
                        </div>
                        {{/if}}
                    </div>

                    {{!-- CAR FOOTER --}}
                    <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold text-success fs-5">{{formatPrice pricePerDay}}‚Ç´</span>
                            <span class="text-muted small">/ng√†y</span>
                        </div>
                        <a href="/cars/detail/{{_id}}" class="btn btn-sm btn-outline-primary">
                            Xem chi ti·∫øt <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                </div>
            </div>
            {{/each}}
            {{else}}
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-car-front text-muted display-1 mb-3 d-block"></i>
                        <h5 class="text-muted">Kh√¥ng t√¨m th·∫•y xe ph√π h·ª£p</h5>
                        <p class="text-secondary">Th·ª≠ ƒëi·ªÅu ch·ªânh b·ªô l·ªçc ho·∫∑c t√¨m ki·∫øm kh√°c</p>
                        <a href="/search" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i>ƒê·∫∑t l·∫°i b·ªô l·ªçc
                        </a>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>

        {{!-- PAGINATION --}}
        {{#if (gt pagination.totalPages 1)}}
        <div class="card border-0 shadow-sm rounded-4 mt-4 overflow-hidden">
            <div class="card-body d-flex justify-content-center align-items-center gap-3">
                {{#if pagination.hasPrevPage}}
                <a href="?page={{subtract pagination.currentPage 1}}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>Trang tr∆∞·ªõc
                </a>
                {{/if}}

                <span class="text-muted fw-bold">
                    Trang {{pagination.currentPage}} / {{pagination.totalPages}}
                </span>

                {{#if pagination.hasNextPage}}
                <a href="?page={{add pagination.currentPage 1}}" class="btn btn-outline-primary">
                    Trang sau<i class="bi bi-arrow-right ms-1"></i>
                </a>
                {{/if}}
            </div>
        </div>
        {{/if}}
    </div>
</div>

<style>
    .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }
</style>

<script>
    function applySort(sortValue) {
        const url = new URL(window.location.href);
        const [sortBy, sortOrder] = sortValue.startsWith('-')
            ? [sortValue.substring(1), 'desc']
            : [sortValue, 'asc'];
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('sortOrder', sortOrder);
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
</script>